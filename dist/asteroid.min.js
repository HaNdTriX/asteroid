!function(t,e){"function"==typeof define&&define.amd?define(e):"object"==typeof exports?module.exports=e():t.Asteroid=e()}(this,function(){"use strict";function t(t){if("undefined"!=typeof EJSON)return EJSON.clone(t);var e=typeof t;switch(e){case"undefined":case"function":return void 0;case"string":case"number":case"boolean":return t;case"object":return null===t?null:JSON.parse(JSON.stringify(t));default:return}}function e(t){var e="";for(var o in t)e+=o+"="+t[o]+"&";return e=e.slice(0,-1)}function o(){for(var t="",e=0;8>e;e++)t+=Math.floor(65536*(1+Math.random())).toString(16).substring(1);return t}function n(t){return-1!==t.indexOf("@")}var i=function(){var t=function(e){if(t.isPromise(e))return e;var o=t.defer();return o.resolve(e),o.promise},e=function(){var t=!1;return function(e){return function(){t||(t=!0,e.apply(null,arguments))}}},o=function(t){var e=t&&t.then;return"object"==typeof t&&"function"==typeof e?function(){return e.apply(t,arguments)}:void 0},n=function(e,o){var n=t.defer(),i=function(t,e){setTimeout(function(){var o;try{o=t(e)}catch(i){return void n.reject(i)}o===n.promise?n.reject(new TypeError("Cannot resolve promise with itself")):n.resolve(o)},1)},s=function(t){e&&e.call?i(e,t):n.resolve(t)},c=function(t){o&&o.call?i(o,t):n.reject(t)};return{promise:n.promise,handle:function(t,e){t===r?s(e):c(e)}}},i=0,r=1,s=2;return t.defer=function(){var t,c=i,a=[],d=function(e,o){c=e,t=o,a.forEach(function(e){e.handle(c,t)}),a=null},l=function(t){d(r,t)},u=function(t){d(s,t)},_=function(e,o){var r=n(e,o);return c===i?a.push(r):r.handle(c,t),r.promise},h=function(t){var o=e();try{t(o(p),o(u))}catch(n){o(u)(n)}},p=function(t){var e;try{e=o(t)}catch(n){return void u(n)}e?h(e):l(t)},f=e();return{resolve:f(p),reject:f(u),promise:{then:_,fail:function(t){return _(null,t)},isFulfilled:function(){return c===r},isRejected:function(){return c===s},isPending:function(){return c===i},inspect:function(){var e={};return c===i?e.state="pending":c===r?(e.state="fulfilled",e.value=t):c===s&&(e.state="rejected",e.reason=t),e}}}},t.isPromise=function(t){return t&&"function"==typeof t.then},t}(),r=function(){var t=function(){var t=0;return function(){return(t++).toString()}}(),e='{"server_id":"0"}',o=10,n=500,i=1e4,r=["added","changed","connected","error","failed","nosub","ready","removed","result","updated","ping","pong"],s=function(t){this._endpoint=t.endpoint,this._SocketConstructor=t.SocketConstructor,this._autoreconnect=!t.do_not_autoreconnect,this._ping_interval=t._ping_interval||i,this._debug=t.debug,this._onReadyCallbacks={},this._onStopCallbacks={},this._onErrorCallbacks={},this._onResultCallbacks={},this._onUpdatedCallbacks={},this._events={},this._queue=[],this.readyState=-1,this._reconnect_count=0,this._reconnect_incremental_timer=0,t.do_not_autoconnect||this.connect()};return s.prototype.constructor=s,s.prototype.connect=function(){this.readyState=0,this._socket=new this._SocketConstructor(this._endpoint),this._socket.onopen=this._on_socket_open.bind(this),this._socket.onmessage=this._on_socket_message.bind(this),this._socket.onerror=this._on_socket_error.bind(this),this._socket.onclose=this._on_socket_close.bind(this)},s.prototype.method=function(e,o,n,i){var r=t();return this._onResultCallbacks[r]=n,this._onUpdatedCallbacks[r]=i,this._send({msg:"method",id:r,method:e,params:o}),r},s.prototype.sub=function(e,o,n,i,r){var s=t();return this._onReadyCallbacks[s]=n,this._onStopCallbacks[s]=i,this._onErrorCallbacks[s]=r,this._send({msg:"sub",id:s,name:e,params:o}),s},s.prototype.unsub=function(t){this._send({msg:"unsub",id:t})},s.prototype.on=function(t,e){this._events[t]=this._events[t]||[],this._events[t].push(e)},s.prototype.off=function(t,e){this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},s.prototype._emit=function(t){if(this._events[t]){var e=arguments,o=this;this._events[t].forEach(function(t){t.apply(o,Array.prototype.slice.call(e,1))})}},s.prototype._send=function(t){if(1!==this.readyState&&"connect"!==t.msg)return void this._queue.push(t);var e;e="undefined"==typeof EJSON?JSON.stringify(t):EJSON.stringify(t),this._debug&&console.log(e),this._socket.send(e)},s.prototype._try_reconnect=function(){this._reconnect_count<o&&setTimeout(this.connect.bind(this),this._reconnect_incremental_timer),this._reconnect_count+=1,this._reconnect_incremental_timer+=n*this._reconnect_count},s.prototype._on_result=function(t){if(this._onResultCallbacks[t.id])this._onResultCallbacks[t.id](t.error,t.result),delete this._onResultCallbacks[t.id],t.error&&delete this._onUpdatedCallbacks[t.id];else if(t.error)throw delete this._onUpdatedCallbacks[t.id],t.error},s.prototype._on_updated=function(t){var e=this;t.methods.forEach(function(t){e._onUpdatedCallbacks[t]&&(e._onUpdatedCallbacks[t](),delete e._onUpdatedCallbacks[t])})},s.prototype._on_nosub=function(t){if(t.error){if(!this._onErrorCallbacks[t.id])throw delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],new Error(t.error);return this._onErrorCallbacks[t.id](t.error),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],void delete this._onErrorCallbacks[t.id]}this._onStopCallbacks[t.id]&&this._onStopCallbacks[t.id](),delete this._onReadyCallbacks[t.id],delete this._onStopCallbacks[t.id],delete this._onErrorCallbacks[t.id]},s.prototype._on_ready=function(t){var e=this;t.subs.forEach(function(t){e._onReadyCallbacks[t]&&(e._onReadyCallbacks[t](),delete e._onReadyCallbacks[t])})},s.prototype._on_error=function(t){this._emit("error",t)},s.prototype._on_connected=function(e){var o=this,n=0===o._reconnect_count,i=n?"connected":"reconnected";o.readyState=1,o._reconnect_count=0,o._reconnect_incremental_timer=0;for(var r=o._queue.length,s=0;r>s;s++)o._send(o._queue.shift());o._emit(i,e),o._ping_interval_handle=setInterval(function(){var e=t();o._send({msg:"ping",id:e})},o._ping_interval)},s.prototype._on_failed=function(t){this.readyState=4,this._emit("failed",t)},s.prototype._on_added=function(t){this._emit("added",t)},s.prototype._on_removed=function(t){this._emit("removed",t)},s.prototype._on_changed=function(t){this._emit("changed",t)},s.prototype._on_ping=function(t){this._send({msg:"pong",id:t.id})},s.prototype._on_pong=function(){},s.prototype._on_socket_close=function(){clearInterval(this._ping_interval_handle),this.readyState=4,this._emit("socket_close"),this._autoreconnect&&this._try_reconnect()},s.prototype._on_socket_error=function(t){clearInterval(this._ping_interval_handle),this.readyState=4,this._emit("socket_error",t)},s.prototype._on_socket_open=function(){this._send({msg:"connect",version:"pre1",support:["pre1"]})},s.prototype._on_socket_message=function(t){var o;if(this._debug&&console.log(t),t.data!==e){try{if(o="undefined"==typeof EJSON?JSON.parse(t.data):EJSON.parse(t.data),-1===r.indexOf(o.msg))throw new Error}catch(n){return console.warn("Non DDP message received:"),void console.warn(t.data)}this["_on_"+o.msg](o)}},s}(),s=function(){};s.prototype={constructor:s,on:function(t,e){this._events||(this._events={}),this._events[t]=this._events[t]||[],this._events[t].push(e)},off:function(t,e){this._events||(this._events={}),this._events[t]&&this._events[t].splice(this._events[t].indexOf(e),1)},_emit:function(t){if(this._events||(this._events={}),this._events[t]){var e=arguments,o=this;this._events[t].forEach(function(t){t.apply(o,Array.prototype.slice.call(e,1))})}}};var c={};c._toString=function(t){return Object.prototype.toString.call(t).slice(8,-1)},c.beString=function(t){var e=this._toString(t);if("String"!==e)throw new Error("Assertion failed: expected String, instead got "+e)},c.beArray=function(t){var e=this._toString(t);if("Array"!==e)throw new Error("Assertion failed: expected Array, instead got "+e)},c.beObject=function(t){var e=this._toString(t);if("Object"!==e)throw new Error("Assertion failed: expected Object, instead got "+e)};var a="undefined"==typeof window?"node":"browser";if("node"===a)var d=require("faye-websocket");var l=function(t,e,o){c.beString(t),this._host=(e?"https://":"http://")+t,"browser"===a&&(this._ddpOptions="function"==typeof SockJS?{endpoint:(e?"https://":"http://")+t+"/sockjs",SocketConstructor:SockJS,debug:o}:{endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:WebSocket,debug:o}),"node"===a&&(this._ddpOptions={endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:d.Client,debug:o}),this.collections={},this.subscriptions={},this._init()};l.prototype=Object.create(s.prototype),l.prototype.constructor=l,l.prototype._init=function(){var t=this;t.ddp=new r(this._ddpOptions),t.ddp.on("connected",function(){"browser"===a&&(t.resumeLoginPromise=t._tryResumeLogin()),t.ddp.sub("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("reconnected",function(){"browser"===a&&(t.resumeLoginPromise=t._tryResumeLogin()),t._reEstablishSubscriptions(),t._emit("reconnected")}),t.ddp.on("added",function(e){t._onAdded(e)}),t.ddp.on("changed",function(e){t._onChanged(e)}),t.ddp.on("removed",function(e){t._onRemoved(e)})},l.prototype._onAdded=function(t){var e=t.collection;this.collections[e]||(this.collections[e]=new l._Collection(e,this));var o=t.fields||{};o._id=t.id,this.collections[e]._remoteToLocalInsert(o)},l.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},l.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},l.prototype.call=function(t){c.beString(t);var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},l.prototype.apply=function(t,e){c.beString(t),Array.isArray(e)||(e=[]);var o=i.defer(),n=i.defer(),r=function(t,e){t?(o.reject(t),n.reject()):o.resolve(e)},s=function(){n.resolve()};return this.ddp.method(t,e,r,s),{result:o.promise,updated:n.promise}},l.prototype.createCollection=function(t){return c.beString(t),this.collections[t]||(this.collections[t]=new l._Collection(t,this)),this.collections[t]};var u="__del__",_="__upd__",h=function(t){var e=u.length,o=_.length,n=t.slice(-1*e),i=t.slice(-1*o);return n===u||i===_},p=function(t,e){this.name=t,this.asteroid=e,this._set=new v};p.prototype.constructor=p,p.prototype._localToLocalInsert=function(t){if(this._set.contains(t._id))throw new Error("Item "+t._id+" already exists");return this._set.put(t._id,t),i(t._id)},p.prototype._remoteToLocalInsert=function(t){this._set.put(t._id,t)},p.prototype._localToRemoteInsert=function(t){var e=this,o=i.defer(),n="/"+e.name+"/insert";return e.asteroid.ddp.method(n,[t],function(n){n?(e._set.del(t._id),o.reject(n)):o.resolve(t._id)}),o.promise},p.prototype.insert=function(t){return t._id||(t._id=o()),{local:this._localToLocalInsert(t),remote:this._localToRemoteInsert(t)}},p.prototype._localToLocalRemove=function(t){var e=this._set.get(t);return e&&(this._set.put(t+u,e),this._set.del(t)),i(t)},p.prototype._remoteToLocalRemove=function(t){this._set.del(t)},p.prototype._localToRemoteRemove=function(t){var e=this,o=i.defer(),n="/"+e.name+"/remove";return e.asteroid.ddp.method(n,[{_id:t}],function(n){if(n){var i=e._set.get(t+u);i&&(e._set.put(t,i),e._set.del(t+u)),o.reject(n)}else e._set.del(t+u),o.resolve(t)}),o.promise},p.prototype.remove=function(t){return{local:this._localToLocalRemove(t),remote:this._localToRemoteRemove(t)}},p.prototype._localToLocalUpdate=function(t,e){var o=this._set.get(t);if(!o)throw new Error("Item "+t+" doesn't exist");if(e._id&&e._id!==t)throw new Error("Modifying the _id of a document is not allowed");this._set.put(t+_,o);for(var n in e)o[n]=e[n];return this._set.put(t,o),i(t)},p.prototype._remoteToLocalUpdate=function(t,e){var o=this._set.get(t);if(!o)return void console.warn("Server misbehaviour: item "+t+" doesn't exist");for(var n in e){if("_id"===n&&e._id!==t)return void console.warn("Server misbehaviour: modifying the _id of a document is not allowed");o[n]=e[n]}this._set.put(t,o)},p.prototype._localToRemoteUpdate=function(t,e){var o=this,n=i.defer(),r="/"+o.name+"/update",s={_id:t},c={$set:e};return o.asteroid.ddp.method(r,[s,c],function(e){if(e){var i=o._set.get(t+_);o._set.put(t,i),o._set.del(t+_),n.reject(e)}else o._set.del(t+_),n.resolve(t)}),n.promise},p.prototype.update=function(t,e){return{local:this._localToLocalUpdate(t,e),remote:this._localToRemoteUpdate(t,e)}};var f=function(t){var e=this;e.result=[],e._set=t,e._getResult(),e._set.on("put",function(t){e._getResult(),e._emit("change",t)}),e._set.on("del",function(t){e._getResult(),e._emit("change",t)})};f.prototype=Object.create(s.prototype),f.constructor=f,f.prototype._getResult=function(){this.result=this._set.toArray()};var g=function(t){return function(e,o){if(h(e))return!1;var n=function(t,e){return e.split(".").reduce(function(t,e){return t?t=t[e]:t},t)};for(var i in t){var r=n(o,i);if(r!==t[i])return!1}return!0}};p.prototype.reactiveQuery=function(t){var e;e="function"==typeof t?t:g(t);var o=this._set.filter(e);return new f(o)},l._Collection=p,"browser"===a&&(l.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",o=this.collections[e],n=o.reactiveQuery({service:t}).result[0];return n.clientId},l.prototype._initOauthLogin=function(t,e,o){var n=window.open(o,"Login"),r=this;return i().then(function(){var t=i.defer();n.focus&&n.focus();var e=setInterval(function(){(n.closed||void 0===n.closed)&&(clearInterval(e),t.resolve())},100);return t.promise}).then(function(){var t=i.defer(),o={oauth:{credentialToken:e}};return r.ddp.method("login",[o],function(e,o){e?(delete r.userId,delete r.loggedIn,delete localStorage[r._host+"__login_token__"],t.reject(e),r._emit("loginError",e)):(r.userId=o.id,r.loggedIn=!0,localStorage[r._host+"__login_token__"]=o.token,r._emit("login",o.id),t.resolve(o.id))}),t.promise})},l.prototype._tryResumeLogin=function(){var t=this,e=i.defer(),o=localStorage[t._host+"__login_token__"];if(!o)return e.reject("No login token"),e.promise;var n={resume:o};return t.ddp.method("login",[n],function(o,n){o?(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("loginError",o),e.reject(o)):(t.userId=n.id,t.loggedIn=!0,localStorage[t._host+"__login_token__"]=n.token,t._emit("login",n.id),e.resolve(n.id))}),e.promise},l.prototype.loginWithFacebook=function(t){var n=o(),i={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:n,scope:t||"email"},r="https://www.facebook.com/dialog/oauth?"+e(i);return this._initOauthLogin("facebook",n,r)},l.prototype.loginWithGoogle=function(t){var n=o(),i={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:n,scope:t||"openid email"},r="https://accounts.google.com/o/oauth2/auth?"+e(i);return this._initOauthLogin("google",n,r)},l.prototype.loginWithGithub=function(t){var n=o(),i={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:n,scope:t||"email"},r="https://github.com/login/oauth/authorize?"+e(i);return this._initOauthLogin("github",n,r)},l.prototype.loginWithTwitter=function(){var t=o(),n=this._host+"/_oauth/twitter?close&state="+t,i={requestTokenAndRedirect:encodeURIComponent(n),state:t},r=this._host+"/_oauth/twitter/?"+e(i);return this._initOauthLogin("twitter",t,r)}),l.prototype.createUser=function(t,e,o){var r=this,s=i.defer(),c={username:n(t)?void 0:t,email:n(t)?t:void 0,password:e,profile:o};return r.ddp.method("createUser",[c],function(t,e){t?(r._emit("createUserError",t),s.reject(t)):(r.userId=e.id,r.loggedIn=!0,localStorage[r._host+"__login_token__"]=e.token,r._emit("createUser",e.id),r._emit("login",e.id),s.resolve(e.id))}),s.promise},l.prototype.loginWithPassword=function(t,e){var o=this,r=i.defer(),s={password:e,user:{username:n(t)?void 0:t,email:n(t)?t:void 0}};return o.ddp.method("login",[s],function(t,e){t?(delete o.userId,delete o.loggedIn,delete localStorage[o._host+"__login_token__"],r.reject(t),o._emit("loginError",t)):(o.userId=e.id,o.loggedIn=!0,localStorage[o._host+"__login_token__"]=e.token,o._emit("login",e.id),r.resolve(e.id))}),r.promise},l.prototype.logout=function(){var t=this,e=i.defer();return t.ddp.method("logout",[],function(o){o?(t._emit("logoutError",o),e.reject(o)):(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("logout"),e.resolve())}),e.promise};var v=function(t){t&&(this._put=this.put,this._del=this.del,this.put=this.del=function(){throw new Error("Attempt to modify readonly set")}),this._items={}};v.prototype=Object.create(s.prototype),v.constructor=v,v.prototype.put=function(e,o){return c.beString(e),c.beObject(o),this._items[e]=t(o),this._emit("put",e),this},v.prototype.del=function(t){return c.beString(t),delete this._items[t],this._emit("del",t),this},v.prototype.get=function(e){return c.beString(e),t(this._items[e])},v.prototype.contains=function(t){return c.beString(t),!!this._items[t]},v.prototype.filter=function(e){var o=new v(!0),n=this._items,i=Object.keys(n);return i.forEach(function(i){var r=t(n[i]),s=e(i,r);s&&(o._items[i]=n[i])}),this.on("put",function(i){var r=t(n[i]),s=e(i,r);s&&o._put(i,n[i])}),this.on("del",function(t){o._del(t)}),o},v.prototype.toArray=function(){var e=[],o=this._items,n=Object.keys(this._items);return n.forEach(function(t){e.push(o[t])}),t(e)},v.prototype.toHash=function(){return t(this._items)},l.Set=v;var m=function(t,e,o){this._name=t,this._params=e,this._asteroid=o,this._ready=i.defer(),this.ready=this._ready.promise;var n=this._onReady.bind(this),r=this._onStop.bind(this),s=this._onError.bind(this);this.id=o.ddp.sub(t,e,n,r,s)};return m.constructor=m,m.prototype.stop=function(){this._asteroid.ddp.unsub(this.id)},m.prototype._onReady=function(){this._ready.resolve()},m.prototype._onStop=function(){delete this._asteroid.subscriptions[this.id]},m.prototype._onError=function(t){this.ready.isPending()&&this._ready.reject(t),delete this._asteroid.subscriptions[this.id]},l.prototype.subscribe=function(t){c.beString(t);var e=Array.prototype.slice.call(arguments,1),o=new m(t,e,this);return this.subscriptions[o.id]=o,o},l.prototype._reEstablishSubscriptions=function(){var t=this.subscriptions;for(var e in t)t[e]=new m(t[e]._name,t[e]._params,this)},l});