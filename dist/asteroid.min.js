var ENV="undefined"==typeof window?"node":"browser";if("node"===ENV)var FayeWebSocket=require("faye-websocket");var Asteroid=function(t,e,o){must.beString(t),this._host=(e?"https://":"http://")+t,"browser"===ENV&&(this._ddpOptions="function"==typeof SockJS?{endpoint:(e?"https://":"http://")+t+"/sockjs",SocketConstructor:SockJS,debug:o}:{endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:WebSocket,debug:o}),"node"===ENV&&(this._ddpOptions={endpoint:(e?"wss://":"ws://")+t+"/websocket",SocketConstructor:FayeWebSocket.Client,debug:o}),this.collections={},this.subscriptions={},this._init()};Asteroid.prototype=Object.create(EventEmitter.prototype),Asteroid.prototype.constructor=Asteroid,Asteroid.prototype._init=function(){var t=this;t.ddp=new DDP(this._ddpOptions),t.ddp.on("connected",function(){"browser"===ENV&&(t.resumeLoginPromise=t._tryResumeLogin()),t.ddp.sub("meteor.loginServiceConfiguration"),t._emit("connected")}),t.ddp.on("reconnected",function(){"browser"===ENV&&(t.resumeLoginPromise=t._tryResumeLogin()),t._reEstablishSubscriptions(),t._emit("reconnected")}),t.ddp.on("added",function(e){t._onAdded(e)}),t.ddp.on("changed",function(e){t._onChanged(e)}),t.ddp.on("removed",function(e){t._onRemoved(e)})},Asteroid.prototype._onAdded=function(t){var e=t.collection;this.collections[e]||(this.collections[e]=new Asteroid._Collection(e,this));var o=t.fields||{};o._id=t.id,this.collections[e]._remoteToLocalInsert(o)},Asteroid.prototype._onRemoved=function(t){this.collections[t.collection]&&this.collections[t.collection]._remoteToLocalRemove(t.id)},Asteroid.prototype._onChanged=function(t){this.collections[t.collection]&&(t.fields||(t.fields={}),t.cleared&&t.cleared.forEach(function(e){t.fields[e]=void 0}),this.collections[t.collection]._remoteToLocalUpdate(t.id,t.fields))},Asteroid.prototype.call=function(t){must.beString(t);var e=Array.prototype.slice.call(arguments,1);return this.apply(t,e)},Asteroid.prototype.apply=function(t,e){must.beString(t),Array.isArray(e)||(e=[]);var o=Q.defer(),i=Q.defer(),r=function(t,e){t?(o.reject(t),i.reject()):o.resolve(e)},n=function(){i.resolve()};return this.ddp.method(t,e,r,n),{result:o.promise,updated:i.promise}},Asteroid.prototype.createCollection=function(t){return must.beString(t),this.collections[t]||(this.collections[t]=new Asteroid._Collection(t,this)),this.collections[t]};var mf_removal_suffix="__del__",mf_update_suffix="__upd__",is_backup=function(t){var e=mf_removal_suffix.length,o=mf_update_suffix.length,i=t.slice(-1*e),r=t.slice(-1*o);return i===mf_removal_suffix||r===mf_update_suffix},Collection=function(t,e){this.name=t,this.asteroid=e,this._set=new Set};Collection.prototype.constructor=Collection,Collection.prototype._localToLocalInsert=function(t){if(this._set.contains(t._id))throw new Error("Item "+t._id+" already exists");return this._set.put(t._id,t),Q(t._id)},Collection.prototype._remoteToLocalInsert=function(t){this._set.put(t._id,t)},Collection.prototype._localToRemoteInsert=function(t){var e=this,o=Q.defer(),i="/"+e.name+"/insert";return e.asteroid.ddp.method(i,[t],function(i){i?(e._set.del(t._id),o.reject(i)):o.resolve(t._id)}),o.promise},Collection.prototype.insert=function(t){return t._id||(t._id=guid()),{local:this._localToLocalInsert(t),remote:this._localToRemoteInsert(t)}},Collection.prototype._localToLocalRemove=function(t){var e=this._set.get(t);return e&&(this._set.put(t+mf_removal_suffix,e),this._set.del(t)),Q(t)},Collection.prototype._remoteToLocalRemove=function(t){this._set.del(t)},Collection.prototype._localToRemoteRemove=function(t){var e=this,o=Q.defer(),i="/"+e.name+"/remove";return e.asteroid.ddp.method(i,[{_id:t}],function(i){if(i){var r=e._set.get(t+mf_removal_suffix);r&&(e._set.put(t,r),e._set.del(t+mf_removal_suffix)),o.reject(i)}else e._set.del(t+mf_removal_suffix),o.resolve(t)}),o.promise},Collection.prototype.remove=function(t){return{local:this._localToLocalRemove(t),remote:this._localToRemoteRemove(t)}},Collection.prototype._localToLocalUpdate=function(t,e){var o=this._set.get(t);if(!o)throw new Error("Item "+t+" doesn't exist");if(e._id&&e._id!==t)throw new Error("Modifying the _id of a document is not allowed");this._set.put(t+mf_update_suffix,o);for(var i in e)o[i]=e[i];return this._set.put(t,o),Q(t)},Collection.prototype._remoteToLocalUpdate=function(t,e){var o=this._set.get(t);if(!o)return void console.warn("Server misbehaviour: item "+t+" doesn't exist");for(var i in e){if("_id"===i&&e._id!==t)return void console.warn("Server misbehaviour: modifying the _id of a document is not allowed");o[i]=e[i]}this._set.put(t,o)},Collection.prototype._localToRemoteUpdate=function(t,e){var o=this,i=Q.defer(),r="/"+o.name+"/update",n={_id:t},s={$set:e};return o.asteroid.ddp.method(r,[n,s],function(e){if(e){var r=o._set.get(t+mf_update_suffix);o._set.put(t,r),o._set.del(t+mf_update_suffix),i.reject(e)}else o._set.del(t+mf_update_suffix),i.resolve(t)}),i.promise},Collection.prototype.update=function(t,e){return{local:this._localToLocalUpdate(t,e),remote:this._localToRemoteUpdate(t,e)}};var ReactiveQuery=function(t){var e=this;e.result=[],e._set=t,e._getResult(),e._set.on("put",function(t){e._getResult(),e._emit("change",t)}),e._set.on("del",function(t){e._getResult(),e._emit("change",t)})};ReactiveQuery.prototype=Object.create(EventEmitter.prototype),ReactiveQuery.constructor=ReactiveQuery,ReactiveQuery.prototype._getResult=function(){this.result=this._set.toArray()};var getFilterFromSelector=function(t){return function(e,o){if(is_backup(e))return!1;var i=function(t,e){return e.split(".").reduce(function(t,e){return t?t=t[e]:t},t)};for(var r in t){var n=i(o,r);if(n!==t[r])return!1}return!0}};Collection.prototype.reactiveQuery=function(t){var e;e="function"==typeof t?t:getFilterFromSelector(t);var o=this._set.filter(e);return new ReactiveQuery(o)},Asteroid._Collection=Collection,"browser"===ENV&&(Asteroid.prototype._getOauthClientId=function(t){var e="meteor_accounts_loginServiceConfiguration",o=this.collections[e],i=o.reactiveQuery({service:t}).result[0];return i.clientId},Asteroid.prototype._initOauthLogin=function(t,e,o){var i=window.open(o,"Login"),r=this;return Q().then(function(){var t=Q.defer();i.focus&&i.focus();var e=setInterval(function(){(i.closed||void 0===i.closed)&&(clearInterval(e),t.resolve())},100);return t.promise}).then(function(){var t=Q.defer(),o={oauth:{credentialToken:e}};return r.ddp.method("login",[o],function(e,o){e?(delete r.userId,delete r.loggedIn,delete localStorage[r._host+"__login_token__"],t.reject(e),r._emit("loginError",e)):(r.userId=o.id,r.loggedIn=!0,localStorage[r._host+"__login_token__"]=o.token,r._emit("login",o.id),t.resolve(o.id))}),t.promise})},Asteroid.prototype._tryResumeLogin=function(){var t=this,e=Q.defer(),o=localStorage[t._host+"__login_token__"];if(!o)return e.reject("No login token"),e.promise;var i={resume:o};return t.ddp.method("login",[i],function(o,i){o?(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("loginError",o),e.reject(o)):(t.userId=i.id,t.loggedIn=!0,localStorage[t._host+"__login_token__"]=i.token,t._emit("login",i.id),e.resolve(i.id))}),e.promise},Asteroid.prototype.loginWithFacebook=function(t){var e=guid(),o={client_id:this._getOauthClientId("facebook"),redirect_uri:this._host+"/_oauth/facebook?close",state:e,scope:t||"email"},i="https://www.facebook.com/dialog/oauth?"+formQs(o);return this._initOauthLogin("facebook",e,i)},Asteroid.prototype.loginWithGoogle=function(t){var e=guid(),o={response_type:"code",client_id:this._getOauthClientId("google"),redirect_uri:this._host+"/_oauth/google?close",state:e,scope:t||"openid email"},i="https://accounts.google.com/o/oauth2/auth?"+formQs(o);return this._initOauthLogin("google",e,i)},Asteroid.prototype.loginWithGithub=function(t){var e=guid(),o={client_id:this._getOauthClientId("github"),redirect_uri:this._host+"/_oauth/github?close",state:e,scope:t||"email"},i="https://github.com/login/oauth/authorize?"+formQs(o);return this._initOauthLogin("github",e,i)},Asteroid.prototype.loginWithTwitter=function(){var t=guid(),e=this._host+"/_oauth/twitter?close&state="+t,o={requestTokenAndRedirect:encodeURIComponent(e),state:t},i=this._host+"/_oauth/twitter/?"+formQs(o);return this._initOauthLogin("twitter",t,i)}),Asteroid.prototype.createUser=function(t,e,o){var i=this,r=Q.defer(),n={username:isEmail(t)?void 0:t,email:isEmail(t)?t:void 0,password:e,profile:o};return i.ddp.method("createUser",[n],function(t,e){t?(i._emit("createUserError",t),r.reject(t)):(i.userId=e.id,i.loggedIn=!0,localStorage[i._host+"__login_token__"]=e.token,i._emit("createUser",e.id),i._emit("login",e.id),r.resolve(e.id))}),r.promise},Asteroid.prototype.loginWithPassword=function(t,e){var o=this,i=Q.defer(),r={password:e,user:{username:isEmail(t)?void 0:t,email:isEmail(t)?t:void 0}};return o.ddp.method("login",[r],function(t,e){t?(delete o.userId,delete o.loggedIn,delete localStorage[o._host+"__login_token__"],i.reject(t),o._emit("loginError",t)):(o.userId=e.id,o.loggedIn=!0,localStorage[o._host+"__login_token__"]=e.token,o._emit("login",e.id),i.resolve(e.id))}),i.promise},Asteroid.prototype.logout=function(){var t=this,e=Q.defer();return t.ddp.method("logout",[],function(o){o?(t._emit("logoutError",o),e.reject(o)):(delete t.userId,delete t.loggedIn,delete localStorage[t._host+"__login_token__"],t._emit("logout"),e.resolve())}),e.promise};var Set=function(t){t&&(this._put=this.put,this._del=this.del,this.put=this.del=function(){throw new Error("Attempt to modify readonly set")}),this._items={}};Set.prototype=Object.create(EventEmitter.prototype),Set.constructor=Set,Set.prototype.put=function(t,e){return must.beString(t),must.beObject(e),this._items[t]=clone(e),this._emit("put",t),this},Set.prototype.del=function(t){return must.beString(t),delete this._items[t],this._emit("del",t),this},Set.prototype.get=function(t){return must.beString(t),clone(this._items[t])},Set.prototype.contains=function(t){return must.beString(t),!!this._items[t]},Set.prototype.filter=function(t){var e=new Set(!0),o=this._items,i=Object.keys(o);return i.forEach(function(i){var r=clone(o[i]),n=t(i,r);n&&(e._items[i]=o[i])}),this.on("put",function(i){var r=clone(o[i]),n=t(i,r);n&&e._put(i,o[i])}),this.on("del",function(t){e._del(t)}),e},Set.prototype.toArray=function(){var t=[],e=this._items,o=Object.keys(this._items);return o.forEach(function(o){t.push(e[o])}),clone(t)},Set.prototype.toHash=function(){return clone(this._items)},Asteroid.Set=Set;var Subscription=function(t,e,o){this._name=t,this._params=e,this._asteroid=o,this._ready=Q.defer(),this.ready=this._ready.promise;var i=this._onReady.bind(this),r=this._onStop.bind(this),n=this._onError.bind(this);this.id=o.ddp.sub(t,e,i,r,n)};Subscription.constructor=Subscription,Subscription.prototype.stop=function(){this._asteroid.ddp.unsub(this.id)},Subscription.prototype._onReady=function(){this._ready.resolve()},Subscription.prototype._onStop=function(){delete this._asteroid.subscriptions[this.id]},Subscription.prototype._onError=function(t){this.ready.isPending()&&this._ready.reject(t),delete this._asteroid.subscriptions[this.id]},Asteroid.prototype.subscribe=function(t){must.beString(t);var e=Array.prototype.slice.call(arguments,1),o=new Subscription(t,e,this);return this.subscriptions[o.id]=o,o},Asteroid.prototype._reEstablishSubscriptions=function(){var t=this.subscriptions;for(var e in t)t[e]=new Subscription(t[e]._name,t[e]._params,this)};